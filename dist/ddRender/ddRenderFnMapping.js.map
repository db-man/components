{"version":3,"file":"ddRenderFnMapping.js","names":["React","Handlebars","ImageLink","ImageLinks","Link","Links","Fragment","PhotoList","ErrorAlert","TextAreaFormFieldValue","getTablePrimaryKey","registerHelper","replaceHelper","find","replace","options","string","fn","arr","sep","join","hash","rows","primaryKey","tables","tableName","row","primaryKeyVal","genRenderFunc","Component","dComponent","val","record","index","args","tplExtra","console","error","createElement","tplStr","tpl","compile","json","extra","props","JSON","parse","err","ddRenderFnMapping"],"sources":["../../src/ddRender/ddRenderFnMapping.tsx"],"sourcesContent":["/* eslint-disable max-len */\n\nimport React from 'react';\n/**\n * When importing like this `import Handlebars from 'handlebars'`, will see below error when running npm run dev\n *\n * ```\n * Failed to compile.\n *\n * Module not found: Error: Can't resolve 'fs' in '/Users/devin.chenyang/source/github.com/db-man/components/node_modules/handlebars/lib'\n * WARNING in ./node_modules/handlebars/lib/index.js 20:38-56\n * require.extensions is not supported by webpack. Use a loader instead.\n *\n * WARNING in ./node_modules/handlebars/lib/index.js 21:2-20\n * require.extensions is not supported by webpack. Use a loader instead.\n *\n * WARNING in ./node_modules/handlebars/lib/index.js 22:2-20\n * require.extensions is not supported by webpack. Use a loader instead.\n * ```\n *\n * The current tmp solution is to use `import Handlebars from 'handlebars/dist/handlebars'` instead.\n *\n * See more: https://github.com/handlebars-lang/handlebars.js/issues/1174\n */\n// import Handlebars from 'handlebars';\n// @ts-ignore Ignore handlebars type error\nimport Handlebars from 'handlebars/dist/handlebars';\n\nimport {\n  ImageLink,\n  ImageLinks,\n  Link,\n  Links,\n  Fragment,\n} from '../components/Links';\nimport PhotoList from '../components/PhotoList';\nimport ErrorAlert from '../components/ErrorAlert';\nimport TextAreaFormFieldValue from '../components/TextAreaFormFieldValue';\nimport { getTablePrimaryKey } from '../utils';\nimport { RowType } from '../types/Data';\nimport DbTable from '../types/DbTable';\nimport { RenderArgs } from '../types/UiType';\n\ninterface Options {\n  fn: (this: any) => string;\n  hash: {\n    rows?: RowType[];\n    tables: DbTable[];\n    tableName: string;\n    primaryKeyVal: any;\n  };\n}\n\n/**\n * tpl: {{#replace \"foo\" \"bar\"}}{{title}}{{/replace}}\n * input: {title:\"foo\"}\n * output: bar\n */\nHandlebars.registerHelper(\n  'replace',\n  function replaceHelper(find: string, replace: string, options: Options) {\n    // @ts-ignore\n    const string = options.fn(this);\n    return string.replace(find, replace);\n  }\n);\n\n/**\n * tpl: {{join record.tags \", \"}}\n * input: {\"tags\": [\"foo\", \"bar\"]}\n * output: \"foo, bar\"\n */\nHandlebars.registerHelper('join', (arr: string[], sep: string) => {\n  if (!arr) return '';\n  return arr.join(sep);\n});\n\nHandlebars.registerHelper('getTableRecordByKey', (options: Options) => {\n  if (!options.hash.rows) return null;\n  const primaryKey = getTablePrimaryKey(\n    options.hash.tables,\n    options.hash.tableName\n  );\n  return options.hash.rows.find(\n    (row: RowType) => row[primaryKey] === options.hash.primaryKeyVal\n  );\n});\n\n/**\n * Generate a render function based on the passing component,\n * so we can later call this render function by passing an Handlebars template to dynamic render component based on the passing record\n * @param {*} Component\n * @returns {()=><Component/>} render function\n */\nconst genRenderFunc = (Component: any) =>\n  function dComponent(\n    val: any,\n    record: RowType,\n    index?: number,\n    args?: RenderArgs,\n    tplExtra?: any\n  ) {\n    if (!record || typeof record !== 'object') {\n      console.error('[genRenderFunc] record should be an object!', record); // eslint-disable-line no-console\n    }\n    if (!args || !args[1]) {\n      return <Component>{val}</Component>;\n    }\n\n    const tplStr = args[1];\n    const tpl = Handlebars.compile(tplStr);\n    const json = tpl({ record, extra: tplExtra });\n    try {\n      // {foo:'bar'} <= \"{\\\"foo\\\":\\\"bar\\\"}\"\n      // \"foo\" <= \"\\\"foo\\\"\"\n      const props = JSON.parse(json);\n      if (typeof props === 'string') {\n        return <Component>{props}</Component>;\n      }\n      return <Component {...props} />; // eslint-disable-line react/jsx-props-no-spreading\n    } catch (err) {\n      console.error('Failed to parse JSON for tpl, err:', err, json);\n      return (\n        <div>\n          val: {val}\n          <ErrorAlert\n            json={json}\n            error={err as Error}\n            tplStr={tplStr}\n            record={record}\n          />\n        </div>\n      );\n    }\n  };\n\ntype DdRenderFnMappingType = Record<\n  string, // render function name, e.g. \"Link\"\n  (\n    val: any,\n    record: RowType,\n    index?: number,\n    args?: RenderArgs,\n    tplExtra?: any\n  ) => JSX.Element\n>;\n\n/**\n * Data Driving Render Function Mapping\n */\nconst ddRenderFnMapping: DdRenderFnMappingType = {\n  // renderFnName: (cellVal, rowVal, colIndex, ...renderFnStr) => null\n  // renderFnName: (cellVal, rowVal, colIndex, ...renderFnProps) => null\n\n  /**\n   * @param {number|string} val e.g. \"docs\"\n   * @param {Object} record e.g. `{\"org\":\"github\",\"repo\":\"docs\"}`\n   * @param {number} index e.g. 9, it's the 10th row\n   * @param {Object|undefined} args e.g `[\"Link\", \"{\\\"href\\\":\\\"https://github.com/{{record.org}}/{{record.repo}}\\\",\\\"text\\\":\\\"{{record.repo}}\\\"}\"]`\n   *                                args could be undefined when column is {\"type:listPage\": \"Link\"}\n   *  Usage:\n   * 1. \"type:getPage\": [\"Link\", \"{\\\"href\\\":\\\"https://github.com/{{record.org}}/{{record.repo}}\\\",\\\"text\\\":\\\"{{record.repo}}\\\"}\"],\n   * 2. \"type:listPage\": [\"Link\", \"{\\\"href\\\":\\\"https://github.com/{{record.org}}/{{record.repo}}\\\",\\\"text\\\":\\\"{{record.repo}}\\\"}\"]\n   * 3. \"type:listPage\": \"Link\"\n   */\n  Link: genRenderFunc(Link),\n  /**\n   * Usage:\n   * ```json\n   * {\"type:listPage\": [\"ImageLink\",\n   *   \"{\\\"url\\\":\\\"{{record.url}}\\\",\\\"imgSrc\\\":\\\"{{record.url}}_th.jpg\\\",\n   *     \\\"tags\\\":\\\"{{record.tags}}\\\"}\"\n   * ]}\n   * ```\n   * Issues:\n   *   When record.url=\"https://foo.com/get?foo=bar\".\n   *   By using `{{record.url}}` will generate \"https://foo.com/get?foo&#x3D;bar\".\n   *   To prevent this issue, `{{{record.url}}}` could be used. (https://handlebarsjs.com/guide/expressions.html#html-escaping)\n   */\n  ImageLink: genRenderFunc(ImageLink),\n  ImageLinks: genRenderFunc(ImageLinks),\n  /**\n   * Usage:\n   * ```json\n   * {\"type:listPage\": [\"Fragment\", \"{{join record.tags \\\", \\\"}}\"]}\n   * ```\n   */\n  Fragment: genRenderFunc(Fragment),\n  Links: genRenderFunc(Links),\n  /**\n   * Usage:\n   * ```json\n   * {\n   *   \"type:getPage\": [\n   *     \"PhotoList\",\n   *     \"[{{#each record.photoUrls}}{{#if @index}},{{/if}}{\\\"url\\\":\\\"{{this}}\\\",\\\"imgSrc\\\":\\\"{{this}}_th.jpg\\\",\\\"description\\\":\\\"{{#with (getTableRecordByKey tables=../extra.tables tableName=\\\"imgs\\\" primaryKeyVal=this rows=../extra.rows)}}{{join tags \\\", \\\"}}{{/with}}\\\"}{{/each}}]\"\n   *   ]\n   * }\n   * ```\n   */\n  PhotoList: genRenderFunc(PhotoList),\n  TextAreaFormFieldValue: genRenderFunc(TextAreaFormFieldValue),\n};\n\nexport default ddRenderFnMapping;\n"],"mappings":"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"}